---
import { Code } from 'astro:components';
import { Image } from 'astro:assets';
import BaseLayout from "@/layouts/BaseLayout.astro";
import SimpleImagePanel from '@/components/SimpleImagePanel.astro'
import BentoCard from '@/components/BentoCard.astro'
import BentoWrapper from '@/components/BentoWrapper.astro'

import multimeterImg from '@/assets/img/lj16-panel/multimeter.jpg'
import originalImg from '@/assets/img/lj16-panel/original.jpg'
import threePhaseBusbarImg from '@/assets/img/lj16-panel/3-phase-busbar.jpg'
import threePhaseBreakerImg from '@/assets/img/lj16-panel/3-phase-breaker.jpg'
import threePhaseJumpersImg from '@/assets/img/lj16-panel/3-phase-jumpers.jpg'
import busbarBadImg from '@/assets/img/lj16-panel/busbar-bad.jpg'
import labelsImg from '@/assets/img/lj16-panel/labels.jpg'
import screwdriverImg from '@/assets/img/lj16-panel/screwdriver.jpg'
import supplyDisconnectedImg from '@/assets/img/lj16-panel/supply-disconnected.jpg'
import onePhaseBusbarImg from '@/assets/img/lj16-panel/1-phase-busbar.jpg'
import frameOutImg from '@/assets/img/lj16-panel/frame-out.jpg'
import cableStrippingImg from '@/assets/img/lj16-panel/cable-stripping.jpg'
import newPanelInImg from '@/assets/img/lj16-panel/new-panel-in.jpg'
import breakersInImg from '@/assets/img/lj16-panel/breakers-in.jpg'
import roughInImg from '@/assets/img/lj16-panel/rough-in.jpg'
import cleanUpImg from '@/assets/img/lj16-panel/clean-up.jpg'
import paintbrushImg from '@/assets/img/lj16-panel/paintbrush.jpg'
import completeImg from '@/assets/img/lj16-panel/complete.jpg'

import wires2circuits from './code/wires2circuits.yaml?raw';
import circuits2breakers from './code/circuits2breakers.yaml?raw';

const title = "Electrical Panel Replacement"
const description = "Replacing a small electrical panel in my Ljubljana apartment to add neutral and ground busbars and a residual current circuit breaker."

const wires = [
  { wire: "cable-1-black", destination: "Breaker 4"},
  { wire: "cable-1-brown", destination: "Breaker 4"},
  { wire: "cable-1-grey", destination: "Capped"},
  { wire: "cable-1-neutral", destination: "Neutral busbar"},
  { wire: "cable-1-ground", destination: "Ground busbar"},
  { wire: "cable-2-black", destination: "Breaker 10"},
  { wire: "cable-2-neutral", destination: "Neutral busbar"},
  { wire: "cable-2-ground", destination: "Ground busbar"},
  { wire: "cable-3-black", destination: "Breaker 10"},
  { wire: "cable-3-brown", destination: "Capped"},
  { wire: "cable-3-grey", destination: "Capped"},
  { wire: "cable-3-neutral", destination: "Neutral busbar"},
  { wire: "cable-3-ground", destination: "Ground busbar"},
]

---

<BaseLayout title={title} description={description}>
  <h1 class="text-5xl">Electrical Panel Replacement</h1>

  <div class="mt-12">
    <SimpleImagePanel
      reverse={true}
      img={multimeterImg}
      imgAlt="Mapping out continuity of breakers in the panel before the replacement using a multimeter."
      imgCaption="Investigating the panel before beginning the rewire and replacement."
      imgClasses="h-96 w-full max-w-sm object-top mx-auto border border-gray-300"
    >
      <p class="max-w-xl">
        <strong class="font-bold">Summary:</strong>
        This page documents replacing the electrical panel in our family's Ljubljana apartment.
      </p>

      <p class="mt-3">
        My initial motivation was to install a residual current circuit breaker (RCCB) as a basic safety measure, but the panel had enough questionable traits beyond the lack of an RCCB that I opted for a full replacement—the details are covered in the following text.
      </p>

      <p class="mt-3">
        The end result is more cramped than I would have liked—a consequence of reusing the existing cavity instead of cutting a new, larger cavity into into the masonry wall to free up space.
        But, crucially, I ended up with properly balanced circuits, residual current/ground fault protection, and a clear picture of what's going on in the panel. 
      </p>

    </SimpleImagePanel>
  </div>

  <h2 class="mt-16 text-4xl text-left">Problems with the previous panel</h2>

  <div class="mt-8">
    <SimpleImagePanel
      reverse={true}
      img={originalImg}
      imgAlt="The original panel, showing chaotic wiring and no cover"
      imgCaption="The original panel was visibly chaotic even to the casual observer, with a number of less-visible quirks described in the text below."
      imgClasses="h-80 w-full max-w-md mx-auto md:h-80"
      captionClasses="max-w-sm"
    >
      <p>
        <span class="font-bold">Initial status:</span>
        Following the sacred electrician's tradition of talking shit on the existing work (not that I can claim to be an electrician, only a shit-talker), here are some of the, um, questionable characteristics I discovered and replaced in the original panel.
        Some are dangerous, some merely curiosities to chuckle at:
      </p>

      <ul class="list-disc mt-5 ml-5">
        <li>No cover</li>
        <li>No neutral or ground busbars</li>
        <li>No ground fault protection</li>
        <li>Overly-stripped wire around connectors (read: exposed copper)</li>
        <li>An undersized 10 ampere main breaker</li>
        <li>Overloaded shared neutral wires</li>
        <li>A 3-phase main breaker and supply rail, even though I have one-phase supply</li>
      </ul>

    </SimpleImagePanel>

    <p class="mt-5">Following is a gallery of some of these problems in more detail.</p>

    <h3 class="mt-5 text-2xl"> Gallery: Problems with the original panel</h3>

    <div class="mt-6">
      <BentoWrapper>

        <BentoCard classes="lg:col-span-2" title="A renegade three-phase breaker..." imgSrc={threePhaseBreakerImg} imgAlt="The three-phase main breaker in the original panel.">
          <p>
            The panel mysteriously used a three phase breaker—note the 400 V rating and three-terminal switching diagram.
            I say mysteriously, because <span class="italic">I have only 1-phase supply!</span>
          </p>

          <details class="mt-1">
            <summary class="cursor-pointer">
              Details
            </summary>
            <p>
              What's going on here? Did I originally have 3-phase power? (This is not unusual in Slovenia like it would be in the USA, even in residential settings.) Who knows...
            </p>

            <p class="mt-2">A consequence: the main breaker was rated for 10 amperes (note the C10 marking)—this makes sense with 3-phase input, where the 10 A rating applies to each phase separately. But with my 1-phase input connected to a single terminal only (see the faintly visible thick black wire entering the third-from-left breakers from the top), the end result is a 10 A main breaker, which is <span class="italic">smaller(!)</span> than some of the 16 A breakers used for individual circuits, meaning the main breaker would trip <span class="italic">before</span> any individual circuit breaker, cutting power to the whole apartment if a single circuit overloads.</p>
          </details>
        </BentoCard>

        <BentoCard classes="lg:col-span-2" title="...made to work with jumper wires..." imgSrc={threePhaseJumpersImg} imgAlt="Close-up image of the jumper cables used to connect the three-phase main breaker's terminals.">
          <p>
            To distribute the single-phase supply (black wire entering the breaker on the top left) among the three-phase breaker's terminals, the original installer connected the terminals together with jumper wires (the two short brown wires in the top terminals), making for the funny-looking contraption shown above.

          <p class="italic mt-2">By the way, look at that brittle insulation and exposed copper!</p>
          </p>
        </BentoCard>

        <BentoCard classes="sm:hidden lg:block lg:col-span-2" title="...because of needless use of a three-phase rail" imgSrc={threePhaseBusbarImg} imgAlt="The removed three-phase rail originally used to distribute power across the breakers of my one-phase panel.">
          <p>
            The panel used a <span class="italic">three-phase</span> supply rail (the piece I am holding in my left hand, with the copper teeth sticking out), even though a one-phase rail would have worked fine for my one-phase supply.
          </p>

          <details class="mt-1">
            <summary class="cursor-pointer">
              Details
            </summary>
            <p>
              A three-phase rail like this has three electrically isolated pieces of copper (every third tooth is electrically connected), meant to keep three phases separate. A one-phase rail would have done just fine for my one-phase supply (and been about three times cheaper, <span class="italic">and</span> absolved the need for the hack with the jumper wires, since all the breakers would have been connected by the single piece of copper anyway).
            </p>
            <p class="mt-2">Evidence points to my having a three-phase supply at one point, and that whoever did the conversion didn't bother to switch to appropriate one-phase material... or perhaps the original installer just had spare three-phase parts lying around he needed to get rid of? It's a mystery to me!</p>
          </details>
        </BentoCard>
      </BentoWrapper>

      <div class="mt-5">
        <BentoWrapper>
          <BentoCard classes="lg:col-span-3" title="Busbars?" imgSrc={originalImg} imgAlt="The original panel, conspicuously missing busbars.">
            The original panel featured a conspicuous lack of either neutral or ground busbars...
          </BentoCard>
          <BentoCard classes="lg:col-span-3 h-fit" title="Who needs busbars?" imgSrc={busbarBadImg} imgAlt="The large connectors used to tie the neutral and ground wires together in place of busbars.">
            ...and just stuffed all the neutral and ground wires into large shared connectors. The remains of the disassembled neutral "busbar" are shown here.
          </BentoCard>
        </BentoWrapper>
      </div>

    </div>

  </div>

  <h2 class="mt-16 text-4xl text-left">Planning...</h2>

  <div class="mt-8">
    <SimpleImagePanel
      reverse={true}
      img={labelsImg}
      imgAlt="Labels placed on the original wires with electrical tape."
      imgCaption="I used labels placed on the original wires (the numbers on the white electrical tape) to keep track of which wire was which when it came to disassembling the old panel."
      imgClasses="h-96 w-full max-w-md mx-auto"
      captionClasses="max-w-sm"
    >
      <span class="font-bold">Summary:</span> The end result of the planning phase was a list of the final destination of every wire in every cable that entered the panel.
      The list looked something like this:

      <table class="my-5 relative min-w-full divide-y divide-gray-300">
        <thead>
          <tr>
            <th scope="col" class="whitespace-nowrap px-2 py-1 text-left text-sm font-semibold text-gray-900">Wire</th>
            <th scope="col" class="whitespace-nowrap px-2 py-1 text-left text-sm font-semibold text-gray-900">Destination</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
          {wires.map((wire) => (
          <tr>
            <td class="whitespace-nowrap px-2 py-1 text-sm font-medium text-gray-900">{wire.wire}</td>
            <td class="whitespace-nowrap px-2 py-1 text-sm font-medium text-gray-00">{wire.destination}</td>
          </tr>
          ))}
          <tr>
            <td class="whitespace-nowrap px-2 py-1 text-sm font-medium text-gray-600">...and so on...</td>
            <td class="whitespace-nowrap px-2 py-1 text-sm font-medium text-gray-600">...for all 11 cables...</td>
          </tr>
        </tbody>
      </table>

      <p>The goal here was ensure everything went smoothly once I began the rewire (i.e. you don't want to discover halfway through rewiring your panel, with the power cut and the freezer thawing, that you forgot to plan out were an extra cable should go).</p>
    </SimpleImagePanel>

    <div class="mt-5 max-w-2xl">
      <h3 class="text-2xl">Planning: Details</h3>
      <p class="mt-3">
        I first mapped out all wires entering the panel to see which circuits they corresponded to, then gave each cable and its constituent wires a label, which I used to keep track of which cable/wire would go where when rewiring.
      </p>

      <p class="mt-2">I then re-planned circuits to:</p>

      <ul class="my-5 ml-5 list-disc">
        <li>eliminate a few shared neutrals</li>
        <li>balance loads on breakers (e.g. previously the fridge and electric oven were on the same circuit breaker, while a separate circuit elsewhere consisted of only a single rarely-used outlet)</li>
        <li>ensure lights where on different breakers than outlets (standard practice so that if a breaker flips from an overloaded outlet the lights in the room stay on to let you figure out what's going on)</li>
        <li>and (within reason) make breakers near each other in the panel correspond to circuits near each other in the apartment.</li>
      </ul>

      The planning went well; there was no confusion come go-time about which wire went where.

      <details class="my-5 bg-gray-50 border border-gray-300 px-4 py-2 rounded-lg">
        <summary class="cursor-pointer">
          <span class="font-semibold">Details:</span>
          I'm a helpless nerd, so the planning was done programmatically.
          Click to expand if you're curious.
        </summary>

        <p class="mt-4">I first mapped wires to the circuits they should supply, then mapped circuits to the breakers that should control them.
          Note the step of indirection here: I'm first thinking in terms of wires and circuits (when designing circuits in the planning stage), then in terms of circuits and breakers (during the actual boots-on-the-ground work of connecting wires to breakers).</p>

        <p class="mt-4">
          I kept the wires-to-circuits mappings and circuits-to-breakers mappings in separate <a href="https://en.wikipedia.org/wiki/YAML" class="text-blue-500 hover:text-blue-600 hover:underline">YAML</a> dictionaries and used a Python program to handle the mapping between them programmatically.
        </p>

        <p class="mt-5">The wires-to-circuits mapping looks like this...</p>
        <Code class="my-5 rounded-lg p-4" code={wires2circuits} lang="yaml" />
        <p>...the circuits-to-breakers looks like this...</p>
        <Code class="my-5 rounded-lg p-4" code={circuits2breakers} lang="yaml" />
        The glue between the two files is a just a simple Python script that loads the YAML data into two dictionaries, iterates over the wires and prints the breaker or busbar the wire should connect to.
        Note that the values in the wires-to-circuits dictionary match the keys in the circuits-to-breakers dictionary, which, given a wire in the wires-to-circuits dictionary, allows constant-time lookup of the corresponding breaker. Of course the O(1) lookup time is completely irrelevant in practice for a ~20-entry dataset :)
      </details>

      <p>With planning done I cut power and begin work (thankfully we have an extra fuse in series between the meter and our panel's main breaker, so I didn't have to work live).</p>

    </div>

  </div>

  <h2 class="mt-16 text-4xl text-left">The Rewire</h2>

  <div class="mt-8">
    <SimpleImagePanel
      reverse={true}
      img={screwdriverImg}
      imgAlt="Removing the old live busbar with an insulated screwdriver"
      imgCaption="Beginning disassembly by removing the old live busbar."
      imgClasses="h-80 w-full max-w-md mx-auto"
      captionClasses="max-w-sm"
    >
      <span class="font-bold">Summary:</span>
      The rewire was uneventful (which is good—I don't want surprises when replacing a panel!).
      The work involved:

      <ul class="my-2 ml-5 list-disc">
        <li>disconnecting all the old wiring and removed the panel frame</li>
        <li>installing the new panel in the existing wall cavity and routed cables into the new panel</li>
        <li>installing ground, neutral, and hot busbars</li>
        <li>installing the RCCB (the RCCB also serves as the main breaker) and circuit breakers</li>
        <li>connecting cables/wires one by one to their destinations on the breakers and neutral/ground busbars</li>
        <li>finishing with the standard de-energized continuity testing and energized voltage testing checklist before fully energizing the circuits.</li>
      </ul>
    </SimpleImagePanel>
  </div>

  <p class="mt-3">
    Routing all wires though a relatively cramped layout made the process slow, but everything went to plan, and all circuits functioned as expected under load. Below is a gallery of the process.
  </p>

  <h3 class="mt-5 text-2xl"> Gallery: The rewiring process</h3>

  <div class="mt-6">
    <BentoWrapper>

      <BentoCard classes="lg:col-span-2" title="Power disconnected" imgSrc={supplyDisconnectedImg} imgAlt="The supply line disconnected and capped off before beginning work.">
        <p>
          I first disconnected and capped off the main supply (black line).
          The gray and brown lines are dead.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="Old frame coming out" imgSrc={frameOutImg} imgAlt="The old panel frame removed.">
        <p>
          The old frame coming out after disconnecting the original wiring.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="Cleaning up insulation" imgSrc={cableStrippingImg} imgAlt="Stripping outer insulation from cables with a utility knife.">
        <p>
          Some of the inbound cables still had the outer insulative sheath on. This would protrude into the new panel if left on, so I stripped it with a utility knife.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="The new panel" imgSrc={newPanelInImg} imgAlt="The new panel installed with cables routed in.">
        <p>
          A dry fit of the new panel enclosure with cables routed in but (clearly!) not yet organized.
          I reused the existing wall cavity.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="Breakers and busbar installed" imgSrc={breakersInImg} imgAlt="Breakers and busbar installed in the new panel">
        <p>
          The breakers and busbars after installation.
          I reused the previous breakers, which were modern thermal/bimetallic MCBs in good condition.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title='Complete "rough-in"' imgSrc={roughInImg} imgAlt="The panel after completing the rewiring but before patching surrounding plaster and cleaning up.">
        <p>
          The completed panel with wires routed and circuits connected. Next: testing the electrical connections, then leveling the panel and plastering in the gaps between the panel and surrounding walls.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="Clean-up" imgSrc={cleanUpImg} imgAlt="Sweeping up scrap wire, insulation, and other debris.">
        <p>
          The stereotype, at least as I know if from the USA, is that electricians do not clean up after themselves. As mentioned earlier, I can hardly claim to be an electrician, so clean-up is appropriate.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="Finishing touches" imgSrc={paintbrushImg} imgAlt="Patching gaps">
        <p>
          After verifying electrical connections and ensuring all circuits worked as expected, I leveled the panel and filled the gaps between the panel and surrounding walls.
        </p>
      </BentoCard>

      <BentoCard classes="lg:col-span-2" title="All done!" imgSrc={completeImg} imgAlt="The complete panel after attaching the cover and completing aesthetic finishing touches.">
        <p>
          The completed panel.
        </p>
      </BentoCard>

    </BentoWrapper>


  </div>




</BaseLayout>
